<html>

<head>
  <title>Human Capabilities - Reaction test</title>
  <style>
    body {
      font-family: sans-serif;
      position: relative;
    }

    #stimulus {
      width: 50px;
      height: 50px;
      background: rgb(246, 156, 85);
      border-radius: 50%;
      position: absolute;
      opacity: 0;

    }
  </style>
</head>

<body>
  <h1 id="title">User Study</h1>
  <h2 id="instruction">Press space to start!</h2>
  <div id="stimulus"></div>
  <p id="time"></p>
  <p id="count"></p>
  <p id="mean"></p>
  <p id="sd"></p>

  <script>
    // if true, the experiment is currently active
    let experimentActive = false;

    // if true, the stimulus is currently visible and the user should press space
    let stimulusIsVisible = false;

    // time at which the stimulus last appeared (in milliseconds, see Date.now())
    let stimulusTimestamp;

    // ID of the timeout that is scheduled to make the stimulus appear.
    // Used to cancel tests when the experiment ends.
    let testStimulusTimeout;

    // recorded reaction times in milliseconds
    let times = [];

    // DOM elements
    let timeElement = document.getElementById('time');
    let countElement = document.getElementById('count');
    let meanElement = document.getElementById('mean');
    let stdDevElement = document.getElementById('sd');
    let instructionElement = document.getElementById('instruction');
    let stimulusElement = document.getElementById('stimulus');

    function getMean(data) {
      let sum = 0;
      for (let value of data) sum += value;
      return sum / data.length;
    }

    function getStandardDeviation(data) {
      let mean = getMean(data);
      let squareSum = 0;
      for (let value of data) squareSum += (value - mean) ** 2;
      return Math.sqrt(squareSum / data.length);
    }

    function clearResults() {
      timeElement.textContent = '';
      countElement.textContent = '';
      meanElement.textContent = '';
      stdDevElement.textContent = '';
    }

    function showResults() {
      let meanDeltaTime = getMean(times);
      let stdDev = getStandardDeviation(times);

      countElement.textContent = 'Count: ' + times.length;
      meanElement.textContent = 'Mean: ' + Math.round(meanDeltaTime) + ' ms';
      stdDevElement.textContent = 'SD: ' + Math.round(stdDev) + ' ms';
    }

    function setStimulusColor(newColor, alpha) {
      stimulusElement.style.backgroundColor = newColor;
      stimulusElement.style.opacity = alpha;
    }

    function startTestTrial() {
      // reset the stimulus
      setStimulusColor('black', 0);
      stimulusIsVisible = false;

      // schedule the stimulus to appear after a random amount of time
      let timeToWaitInSeconds = Math.random() * 4 + 2; // 2 - 6s
      testStimulusTimeout = setTimeout(
        showStimulus,
        timeToWaitInSeconds * 1000
      );
    }

    async function showStimulus() {
      setStimulusColor('red', 0);
      makeTheCircleBoiDarkerAlotOfTimes()
      stimulusIsVisible = true;
      stimulusTimestamp = Date.now();
      stimulusElement.style.top = getRndInteger(50, window.innerHeight-50);
      stimulusElement.style.left = getRndInteger(0, window.innerWidth-50);
    }

    function recordStimulusReactionTime() {
      let deltaTime = Date.now() - stimulusTimestamp;
      times.push(deltaTime);
      timeElement.textContent = deltaTime + ' ms';
    }

    function makeTheCircleBoiDarkerAlotOfTimes() {
      const stimulus = stimulusElement;
      let opacity = 0;
      let interval = setInterval(function makeTheCircleBoiDarker() {
        if (opacity < 1 && stimulusIsVisible) {
          stimulusElement.style.opacity = opacity;
          opacity += 0.01;
        } else {
          clearInterval(interval)
        }
      },
        100);
    }

    function getRndInteger(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }

    function startExperiment() {
      clearResults(); // clear results of any previous tests
      instructionElement.textContent =
        "Press space when the color changes! Press 'a' for results!";

      // reset data and start tests
      times = [];
      experimentActive = true;
      startTestTrial();
    }

    function stopExperiment() {
      // cancel any ongoing tests
      clearTimeout(testStimulusTimeout);
      stimulusIsVisible = false;
      experimentActive = false;

      // reset instruction and show results
      instruction.textContent = 'Press space to start!';
      showResults();
    }

    window.addEventListener('keydown', (event) => {
      if (event.key === ' ') {
        // the user pressed the space key
        if (!experimentActive) {
          // start the experiment if it wasn't active
          startExperiment();
          return;
        }

        if (stimulusIsVisible) {
          // record reaction time
          recordStimulusReactionTime();
          // start next trial
          startTestTrial();
        }
      } else if (event.key === 'a') {
        if (experimentActive) {
          // stop the experiment and show results
          stopExperiment();
        }
      } else if (event.key === 'b') {
        // ...
      }
    });
  </script>
</body>

</html>